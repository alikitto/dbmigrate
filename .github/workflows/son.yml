name: Migrate Railway -> Supabase
on: workflow_dispatch

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets
        env:
          RAILWAY_DB_URL: ${{ secrets.RAILWAY_DB_URL }}
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          set -e
          [ -z "$RAILWAY_DB_URL" ] && echo "RAILWAY_DB_URL empty" && exit 1
          [ -z "$SUPABASE_POOLED_URL" ] && echo "SUPABASE_POOLED_URL empty" && exit 1
          echo "OK"

      - name: Dump SCHEMA from Railway
        env:
          RAILWAY_DB_URL: ${{ secrets.RAILWAY_DB_URL }}
        run: |
          set -euxo pipefail
          mkdir -p dumps
          docker run --rm -v "$PWD/dumps:/dumps" postgres:16 \
            pg_dump "$RAILWAY_DB_URL" --schema-only --no-owner --no-privileges \
            --quote-all-identifiers --file=/dumps/schema.sql
          sed -i 's/\r$//' dumps/schema.sql || true

      - name: Apply SCHEMA to Supabase (ignore exists)
        env:
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          set -euxo pipefail
          docker run --rm -e SUPABASE_POOLED_URL="$SUPABASE_POOLED_URL" -v "$PWD/dumps:/dumps" postgres:16 \
            bash -lc 'psql "$SUPABASE_POOLED_URL" -v ON_ERROR_STOP=0 -f /dumps/schema.sql'

      - name: Ensure common extensions
        env:
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          docker run --rm -e SUPABASE_POOLED_URL="$SUPABASE_POOLED_URL" postgres:16 \
            psql "$SUPABASE_POOLED_URL" -v ON_ERROR_STOP=0 -c \
            "create extension if not exists pgcrypto;
             create extension if not exists \"uuid-ossp\";
             create extension if not exists citext;
             create extension if not exists pg_trgm;"

      - name: Dump DATA from Railway (public schema)
        env:
          RAILWAY_DB_URL: ${{ secrets.RAILWAY_DB_URL }}
        run: |
          set -euxo pipefail
          docker run --rm -v "$PWD/dumps:/dumps" postgres:16 \
            pg_dump "$RAILWAY_DB_URL" --data-only --inserts --no-owner --no-privileges \
            --quote-all-identifiers --file=/dumps/data.sql
          sed -i 's/\r$//' dumps/data.sql || true

      - name: Truncate target tables before load (avoid duplicates)
        env:
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          docker run --rm -e SUPABASE_POOLED_URL="$SUPABASE_POOLED_URL" postgres:16 \
            psql "$SUPABASE_POOLED_URL" -v ON_ERROR_STOP=1 -c \
            "do $$
             declare r record;
             begin
               for r in select schemaname, tablename from pg_tables where schemaname='public'
               loop execute format('truncate table %I.%I restart identity cascade', r.schemaname, r.tablename);
               end loop;
             end $$;"

      - name: Load DATA to Supabase
        env:
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          set -euxo pipefail
          docker run --rm -e SUPABASE_POOLED_URL="$SUPABASE_POOLED_URL" -v "$PWD/dumps:/dumps" postgres:16 \
            bash -lc 'psql "$SUPABASE_POOLED_URL" -v ON_ERROR_STOP=1 -f /dumps/data.sql'

      - name: Fix sequences after import
        env:
          SUPABASE_POOLED_URL: ${{ secrets.SUPABASE_POOLED_URL }}
        run: |
          docker run --rm -e SUPABASE_POOLED_URL="$SUPABASE_POOLED_URL" postgres:16 \
            psql "$SUPABASE_POOLED_URL" -v ON_ERROR_STOP=1 -c \
            "do $$
             declare r record;
             begin
               for r in
                 select pg_get_serial_sequence(quote_ident(n.nspname)||'.'||quote_ident(c.relname), a.attname) as seq,
                        quote_ident(n.nspname)||'.'||quote_ident(c.relname) as fq_tbl,
                        a.attname as col
                 from pg_class c
                 join pg_namespace n on n.oid=c.relnamespace
                 join pg_attribute a on a.attrelid=c.oid and a.attnum>0
                 join pg_attrdef d on d.adrelid=c.oid and d.adnum=a.attnum
                 where c.relkind='r' and n.nspname='public' and d.adsrc like 'nextval(%'
               loop
                 execute format('select setval(%L, coalesce((select max(%I) from %s),1), true)', r.seq, r.col, r.fq_tbl);
               end loop;
             end $$;"
